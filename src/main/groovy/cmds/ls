#!/usr/bin/env groovy
package cmds

import scms.Scm

def withRepos(def scm, def prj) {
    scm.getRepos(prj)
}


def execute(def args, def options, def switches, def config) {
    def (scmName,project) = (args[0] =~ '(ss|bb):([A-Za-z]+|\\*)').with { matches() ? it[0][1..2] : []}
    Scm scm = toscm(scmName)
    if (!project || '*' == project) {
        return [
                scm.getProjects().collect { prj ->
                    [
                            id   : prj.id,
                            name : prj.key,
                            href : prj.links.self.href[0],
                            repos: withRepos(scm, prj.key),
                    ]
                }
        ]
    } else {
        return args.with { it as Set }.collect { arg ->
            scm.getProject(project).with { prj ->
                [
                        id   : prj.id,
                        name : prj.key,
                        href : prj.links.self.href,
                        repos: withRepos(scm, prj.key),
                ]
            }
        }
    }
}

return this.&execute



